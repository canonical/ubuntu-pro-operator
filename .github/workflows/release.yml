name: Release Charms to Edge

on:
  push:
    branches:
      - main

jobs:
  test:
    uses: ./.github/workflows/ci-tests.yml

  release:
    name: Build and Release Charms
    runs-on: ubuntu-latest
    needs: [test]
    strategy:
      matrix:
        charm: 
          - name: ubuntu-pro
            target: ubuntu-pro
            track: latest/edge
          - name: ubuntu-pro_noble
            target: ubuntu-pro_noble
            track: latest/edge
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@v0.1.3
        with:
          channel: latest/stable

      - name: Install charmcraft
        run: sudo snap install charmcraft --classic

      - name: Build ${{ matrix.charm.name }}
        run: make ${{ matrix.charm.target }}

      - name: Release to Charmhub
        uses: canonical/data-platform-workflows/.github/workflows/release_charm_edge.yaml@v32.1.0
        with:
          track: ${{ matrix.charm.track }}
          artifact-prefix: ""
          path-to-charm-directory: .
        secrets:
          charmhub-token: ${{ secrets.CHARMHUB_TOKEN }}
        permissions:
          contents: write